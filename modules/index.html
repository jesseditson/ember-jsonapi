<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>ember-jsonapi | Modules</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">ember-jsonapi</h1>
      <h2 class="project-tagline">Create automatic JSONAPI endpoints based on incredibly simple JSON schemas.</h2>
      <nav>
        <a href="/home" class="btn">Home</a>
        <a href="/modules" class="btn">Modules</a>
        <a href="/guide" class="btn">Guide</a>
        <a href="/api" class="btn">API Docs</a>
        <a href="https://github.com/jesseditson/ember-jsonapi" class="btn">GitHub</a>
      </nav>
    </section>

    <section class="main-content">
      <h3 id="modules">Modules</h3>
<p>The core functionality of this project is broken out into 3 npm modules:</p>
<ul>
<li><a href="#jsonapi-schema">jsonapi-schema</a></li>
<li><a href="#jsonapi-express">jsonapi-express</a></li>
<li><a href="#jsonapi-knex">jsonapi-knex</a></li>
</ul>
<h1 id="-a-name-jsonapi-schema-a-jsonapi-schema-"><a name="jsonapi-schema"></a><code>jsonapi-schema</code></h1>
<hr>
<p>This module has two responsibilities:</p>
<ul>
<li>Loading schema json files from a local file system and serializing them to a json object.</li>
</ul>
<p>It handles both pod style <code>app/article/schema.json</code> and legacy style <code>app/schemas/article.json</code> paths, and while intended for use with ember-jsonapi, is framework agnostic.</p>
<ul>
<li>Generating a parser capable of handling simply formatted data and decorating with JSON API structure.</li>
</ul>
<p>A simple example of how to use this module is as follows:</p>
<pre><code class="lang-javascript"><span class="hljs-built_in">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-built_in">var</span> schema = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonapi-schema'</span>);
<span class="hljs-built_in">var</span> schemas = schema.loadSchemas(path.join(process.cwd(), <span class="hljs-string">'app'</span>));

<span class="hljs-built_in">var</span> toJSONAPI = JSONAPI(schemas, <span class="hljs-string">'/api'</span>);
<span class="hljs-built_in">var</span> toArticle = toJSONAPI(<span class="hljs-string">'article'</span>);

<span class="hljs-built_in">var</span> response = toArticle({
  <span class="hljs-attribute">id:</span><span class="hljs-string"> 1,
  title</span>: <span class="hljs-string">'JSON API Paints my bikeshed'</span>
}, {
  <span class="hljs-attribute">included</span>: {
    <span class="hljs-attribute">comments</span>: [
      { <span class="hljs-attribute">id:</span><span class="hljs-string"> 5, body</span>: <span class="hljs-string">'First!'</span> }
    ]
  }
})
</code></pre>
<p>In the above example, response would be serialized to the following:</p>
<pre><code>{
  <span class="hljs-attr">"links"</span>: {
    <span class="hljs-attr">"self"</span>: <span class="hljs-string">"/api/articles"</span>
  },
  <span class="hljs-attr">"data"</span>: [{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"articles"</span>,
    <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">"attributes"</span>: {
      <span class="hljs-attr">"title"</span>: <span class="hljs-string">"JSON API paints my bikeshed!"</span>
    },
    <span class="hljs-attr">"relationships"</span>: {
      <span class="hljs-attr">"comments"</span>: {
        <span class="hljs-attr">"links"</span>: {
          <span class="hljs-attr">"self"</span>: <span class="hljs-string">"/api/articles/1/relationships/comments"</span>,
          <span class="hljs-attr">"related"</span>: <span class="hljs-string">"/api/articles/1/comments"</span>
        },
        <span class="hljs-attr">"data"</span>: [
          { <span class="hljs-attr">"type"</span>: <span class="hljs-string">"comments"</span>, <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span> }
        ]
      }
    },
    <span class="hljs-attr">"links"</span>: {
      <span class="hljs-attr">"self"</span>: <span class="hljs-string">"/api/articles/1"</span>
    }
  }],
  <span class="hljs-attr">"included"</span>: [{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"comments"</span>,
    <span class="hljs-attr">"id"</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">"attributes"</span>: {
      <span class="hljs-attr">"body"</span>: <span class="hljs-string">"First!"</span>
    },
    <span class="hljs-attr">"links"</span>: {
      <span class="hljs-attr">"self"</span>: <span class="hljs-string">"/api/comments/5"</span>
    }
  }]
}
</code></pre><p>The intent of <code>jsonapi-schema</code> is not necessarily to be used in an isolated context, but to provide a simple way of ingesting common relational database responses and serializing them to JSON API documents with as little manipulation as possible.</p>
<h1 id="-a-name-jsonapi-express-a-jsonapi-express-"><a name="jsonapi-express"></a> <code>jsonapi-express</code></h1>
<hr>
<p>This module is an express middleware that is generated by passing schemas to it. When called with a schemas object (as generated by <code>jsonapi-schema</code> above), it will automatically create endpoints for the passed objects. For instance, building on the above example, you could load your schemas and call it like so:</p>
<pre><code class="lang-javascript"><span class="hljs-built_in">var</span> JSONAPI = <span class="hljs-keyword">require</span>(<span class="hljs-string">'jsonapi-express'</span>);
<span class="hljs-built_in">var</span> schema = <span class="hljs-keyword">require</span>(<span class="hljs-string">'jsonapi-schema'</span>);
<span class="hljs-built_in">var</span> path = <span class="hljs-keyword">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-built_in">var</span> schemas = schema.loadSchemas(path.<span class="hljs-keyword">join</span>(process.cwd(), <span class="hljs-string">'app'</span>));

<span class="hljs-built_in">var</span> operations = {}; <span class="hljs-comment">// more on operations below</span>

app.use(<span class="hljs-string">'/api'</span>, JSONAPI(operations, schemas, <span class="hljs-string">'/api'</span>));
</code></pre>
<p>The above, when passed our article schema, would create the following endpoints:</p>
<pre><code>GET    /api/articles
GET    /api/articles/<span class="hljs-symbol">:id</span>
POST   /api/articles
PATCH  /api/articles/<span class="hljs-symbol">:id</span>
DELETE /api/articles/<span class="hljs-symbol">:id</span>
GET    /api/articles/<span class="hljs-symbol">:id/comments</span>
GET    /api/articles/<span class="hljs-symbol">:id/relationships/comments</span>
POST   /api/articles/<span class="hljs-symbol">:id/relationships/comments</span>
PATCH  /api/articles/<span class="hljs-symbol">:id/relationships/comments</span>
DELETE /api/articles/<span class="hljs-symbol">:id/relationships/comments</span>
</code></pre><p><code>jsonapi-express</code> handles setting the correct headers, returning the correct error codes, and aims to be a common module that can track against the JSON API spec without having to manually update resource routes in your application.</p>
<p>To function though, <code>jsonapi-express</code> requires an operations object to be passed in, with the following required keys:</p>
<ul>
<li><code>findAll</code>: a function for finding records</li>
<li><code>findOne</code>: a function for finding a single record</li>
<li><code>create</code>:  a function for creating a record</li>
<li><code>delete</code>:  a function for deleting a record</li>
<li><code>updateRelationship</code>: a function for updating the relationship between two records</li>
</ul>
<p>In addition, the following optional operations can be passed in:</p>
<ul>
<li><code>transforms</code>: a hash of <code>[schema name] : [function]</code> pairs, which is called whenever this record is fetched from the db, before it is parsed by <code>jsonapi-schema</code>. This is useful for modifying data without having to specify an if statement inside of a query operation.</li>
<li><code>authorize</code>: an express middleware that is expected to either call <code>next</code> if the user is allowed to access <code>req.url</code>, or send a <code>4xx</code> if not.</li>
</ul>
<p>For more information on operation method signatures and usage, see the <a href="#todo">jsonapi-express documentation</a>.</p>
<h1 id="-a-name-jsonapi-knex-a-jsonapi-knex-"><a name="jsonapi-knex"></a> <code>jsonapi-knex</code></h1>
<hr>
<p>The final piece of <code>ember-jsonapi</code> is a preconfigured operations hash. <code>jsonapi-knex</code> exports a function that will generate an operations object so you don&#39;t have to write your own database queries. It uses <a href="http://knexjs.org/">knex.js</a> to build sql queries, and as such is compatible with Postgres, MSSQL, MySQL, MariaDB, SQLite3, and Oracle.</p>
<p>It is fairly opinionated in the way it requests data, with the only configuration options being the database, schemas, and the option of specifying table names that differ from schema names. It is meant to be a base to build on rather than a comprehensive ORM.</p>
<p>To tie all three together (which is what the <code>api</code> blueprint does), you&#39;d do the following:</p>
<pre><code class="lang-javascript"><span class="hljs-built_in">var</span> JSONAPI = <span class="hljs-keyword">require</span>(<span class="hljs-string">'jsonapi-express'</span>);
<span class="hljs-built_in">var</span> schema = <span class="hljs-keyword">require</span>(<span class="hljs-string">'jsonapi-schema'</span>);
<span class="hljs-built_in">var</span> path = <span class="hljs-keyword">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-built_in">var</span> schemas = schema.loadSchemas(path.<span class="hljs-keyword">join</span>(process.cwd(), <span class="hljs-string">'app'</span>));
<span class="hljs-built_in">var</span> db = <span class="hljs-keyword">require</span>(<span class="hljs-string">'../lib/db'</span>);
<span class="hljs-built_in">var</span> JSONAPIOperations = <span class="hljs-keyword">require</span>(<span class="hljs-string">'jsonapi-knex'</span>)(db, schemas);

<span class="hljs-comment">// add your transforms or modify operations here</span>

app.use(<span class="hljs-string">'/api'</span>, JSONAPI(JSONAPIOperations, schemas, <span class="hljs-string">'/api'</span>));
</code></pre>
<p>The <code>lib/db.js</code> file just uses the <code>knexfile.js</code> (a knex convention) to load your database config, like so:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> configs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../knexfile.js'</span>)
<span class="hljs-keyword">var</span> env = process.env.NODE_ENV || <span class="hljs-string">'development'</span>
<span class="hljs-keyword">var</span> config = configs[env]
<span class="hljs-keyword">if</span> (!config) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`No db config defined for environment <span class="hljs-subst">${env}</span>`</span>)
<span class="hljs-built_in">module</span>.exports = <span class="hljs-built_in">require</span>(<span class="hljs-string">'knex'</span>)(config)
</code></pre>
<p>If an operation needs to do something special, you can override the operation using standard javascript patterns, e.g.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> JSONAPIOperations = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonapi-knex'</span>)(db, schemas);

<span class="hljs-keyword">var</span> findAll = JSONAPIOperations.findAll;
JSONAPIOperations.findAll = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-keyword">type</span></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'special-case'</span>) <span class="hljs-keyword">return</span> fetchSpecial.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  <span class="hljs-keyword">return</span> findAll.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
}
</code></pre>


      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/jesseditson/ember-jsonapi">ember-jsonapi</a> is maintained by <a href="https://github.com/jesseditson">jesseditson</a>.</span>
      </footer>

    </section>


  </body>
</html>
